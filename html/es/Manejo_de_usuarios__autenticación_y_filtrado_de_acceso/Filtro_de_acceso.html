<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="description" content="A free, read-frendly and open-source book on ZF3">
<meta name="keywords" content="zend framework,book,beginner,free">
<meta name="author" content="2018 by Oleg Krivtsov">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="../../favicon.ico" rel="shortcut icon" type="image/ico" />
<link href="../../assets/css/style.css" type="text/css" rel="stylesheet" />
<title>Filtro de acceso &ndash; Using Zend Framework 3</title>
</head>
<body>
<header>
    <div class="header">
        <div class="header-body">
            <div class="book-title">
                <a href="../../index.html">Using Zend Framework 3</a>
            </div>
            <div class="book-subtitle">
                A free, read-frendly and open-source book on ZF3            </div>
            <nav>
                <div class="menu">
                                        <div class="link">
                        <a href="https://olegkrivtsov.github.io/using-zend-framework-3-book/html">Home</a>
                    </div>
                                        <div class="link">
                        <a href="https://github.com/olegkrivtsov/using-zf3-book-samples">Samples</a>
                    </div>
                                        <div class="link">
                        <a href="https://olegkrivtsov.github.io/zf3-api-reference/html/">Class Reference</a>
                    </div>
                                        <div class="link">
                        <a href="https://github.com/olegkrivtsov/using-zend-framework-3-book">Contribute</a>
                    </div>
                    
                </div>
            </nav>
        </div>    
    </div>
</header>    
<div id="container">
<!-- Navigation -->
<div class="navigation">
    <div class="prev-chapter">
        
        <a href="../Manejo_de_usuarios__autenticación_y_filtrado_de_acceso/Implementar_la_autenticación_del_usuario.html">
            <img alt="Previous Chapter" src="../../assets/images/left.png"><span class="nav-btn-text">Previous</span>
        </a>
        </div>    
    <div class="contents">
        <a href="../toc.html">
            <img alt="Contents" src="../../assets/images/book.png"><span class="nav-btn-text">Contents</span>
        </a>
    </div>
    <div class="next-chapter">
                <a href="../Manejo_de_usuarios__autenticación_y_filtrado_de_acceso/Identity_Controller_Plugin_y_el_View_Helper.html">
            <span class="nav-btn-text">Next</span><img alt="Next Chapter" src="../../assets/images/right.png">
        </a>
            </div>
        <div class="current-chapter">
        <a href="../Manejo_de_usuarios__autenticación_y_filtrado_de_acceso.html">
            <img alt="Contents" src="../../assets/images/upload.png"><span class="nav-btn-text">Manejo de usuarios, autenticación y filtrado de acceso</span>
        </a>
    </div>
    </div>

﻿<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Using Zend Framework 3 Book - Chapter - Adaptive -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3933778336056438"
     data-ad-slot="4531860323"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!-- Chapter content -->
<div id="chapter_content">
<div class="incomplete-translation">
    Translation into this language is not yet finished. You can help this project 
    by translating the chapters and contributing your changes.
</div>

<h2 id="Filtro_de_acceso">16.8. Filtro de acceso</h2>
<p>La última cosa que se implementa en el modulo de usuarios es el <em>filtro de acceso</em>. El filtro de acceso
se usa para restringir el acceso a determinadas páginas permitiendo el acceso solo a usuarios autorizados.</p>
<p>El filtro de acceso trabaja de la siguiente manera:</p>
<ul>
<li><p>Cuando alguien intenta acceder a una página web, revisamos la llave <code>access_filter</code> de la configuración
y determinamos si se permite el acceso a la página a cualquiera o solo a usuarios autorizados.</p>
</li>
<li><p>Si la página esta disponible para cualquiera se permite al visitante ver la página.</p>
</li>
<li><p>Si la página puede ser accedida solo por usuarios autorizados, revisamos si el usuario esta autorizado o no.</p>
</li>
<li><p>Si el usuario no esta autorizado se redirecciona a la página de login y se piden las credenciales.</p>
</li>
<li><p>Una vez que el usuario inicia sesión se le redirecciona a la página original.</p>
</li>
</ul>
<p>El filtro de acceso esta diseñado para funcionar en uno de estos dos modos: restrictive (por defecto) y permissive.
En el modo restrictive el filtro prohíbe el acceso no autorizado a cualquier página que no esta listada en la llave <code>access_filter</code>.</p>
<p>La llave de configuración <code>access_filter</code> se encuentra dentro del archivo <em>module.config.php</em> y será usada
por el filtro de acceso. La llave contiene una lista de controladores y nombres de acciones, para cada acción
se permitirá o ver la página a cualquiera o ver la página solo a los usuarios autorizados. Un ejemplo de la
estructura de la llave se muestra abajo:</p>
<pre class=""><code class="language-php">// The 'access_filter' key is used by the User module to restrict or permit
// access to certain controller actions for unauthenticated visitors.
'access_filter' =&gt; [
    'options' =&gt; [
        // The access filter can work in 'restrictive' (recommended) or 'permissive'
        // mode. In restrictive mode all controller actions must be explicitly listed
        // under the 'access_filter' config key, and access is denied to any not listed
        // action for not logged in users. In permissive mode, if an action is not listed
        // under the 'access_filter' key, access to it is permitted to anyone (even for
        // not logged in users. Restrictive mode is more secure and recommended to use.
        'mode' =&gt; 'restrictive'
    ],
    'controllers' =&gt; [
        Controller\IndexController::class =&gt; [
            // Allow anyone to visit "index" and "about" actions
            ['actions' =&gt; ['index', 'about'], 'allow' =&gt; '*'],
            // Allow authorized users to visit "settings" action
            ['actions' =&gt; ['settings'], 'allow' =&gt; '@']
        ],
    ]
],
</code></pre>
<p>Dentro de la llave <code>access_filter</code> tenemos dos subllaves:</p>
<ul>
<li>La llave <code>options</code> puede ser usado para definir el modo en que los filtros funcionan ("restrictive" o "permissive").</li>
<li>La llave <code>controllers</code> lista los controladores y sus acciones especificando el tipo de acceso para cada acción. El
carácter asterisco (*) significa que cualquiera es capaz de acceder a la página web. El carácter arroba (@) significa
que solo los usuarios autorizados son capaces de acceder a la página.</li>
</ul>
<blockquote class="notquote information" data-type="information"><p> La implementación del filtro de acceso es muy simple. Este no puede, por ejemplo, permitir el acceso basado en nombres
 o por roles de usuarios. Sin embargo, podemos fácilmente modificar y extenderla como deseemos. Si planeas introducir
 un control de acceso basado en roles (RBAC), revisa la documentación para el componente de Zend Framework <code>Zend\Permissions\Rbac</code>.</p>
</blockquote><h3 id="Agregar_el_listener_event_dispatch">16.8.1. Agregar el listener event dispatch</h3>
<p>Para implementar el filtro de control de acceso, usaremos un listener event. Podemos familiarizados con
los listener event revisando el capítulo <a  href="../Crear_un_nuevo_módulo.html">Crear un nuevo modulo</a>.</p>
<p>Prestaremos antención especialmente al evento <em>Dispatch</em>. El evento <em>Dispatch</em> es lanzado después del evento <em>Route</em>,
cuando el controllador y la acción son determinados. Para implementar el listener modificamos el archivo <em>Module.php</em>
del modulo <em>User</em> de la siguiente manera:</p>
<pre class=""><code class="language-php">&lt;?php
namespace User;

use Zend\Mvc\MvcEvent;
use Zend\Mvc\Controller\AbstractActionController;
use User\Controller\AuthController;
use User\Service\AuthManager;

class Module
{
    /**
     * This method returns the path to module.config.php file.
     */
    public function getConfig()
    {
        return include __DIR__ . '/../config/module.config.php';
    }

    /**
     * This method is called once the MVC bootstrapping is complete and allows
     * to register event listeners.
     */
    public function onBootstrap(MvcEvent $event)
    {
        // Get event manager.
        $eventManager = $event-&gt;getApplication()-&gt;getEventManager();
        $sharedEventManager = $eventManager-&gt;getSharedManager();
        // Register the event listener method.
        $sharedEventManager-&gt;attach(AbstractActionController::class,
                MvcEvent::EVENT_DISPATCH, [$this, 'onDispatch'], 100);
    }

    /**
     * Event listener method for the 'Dispatch' event. We listen to the Dispatch
     * event to call the access filter. The access filter allows to determine if
     * the current visitor is allowed to see the page or not. If he/she
     * is not authorized and is not allowed to see the page, we redirect the user
     * to the login page.
     */
    public function onDispatch(MvcEvent $event)
    {
        // Get controller and action to which the HTTP request was dispatched.
        $controller = $event-&gt;getTarget();
        $controllerName = $event-&gt;getRouteMatch()-&gt;getParam('controller', null);
        $actionName = $event-&gt;getRouteMatch()-&gt;getParam('action', null);

        // Convert dash-style action name to camel-case.
        $actionName = str_replace('-', '', lcfirst(ucwords($actionName, '-')));

        // Get the instance of AuthManager service.
        $authManager = $event-&gt;getApplication()-&gt;getServiceManager()-&gt;get(AuthManager::class);

        // Execute the access filter on every controller except AuthController
        // (to avoid infinite redirect).
        if ($controllerName!=AuthController::class &amp;&amp;
            !$authManager-&gt;filterAccess($controllerName, $actionName)) {

            // Remember the URL of the page the user tried to access. We will
            // redirect the user to that URL after successful login.
            $uri = $event-&gt;getApplication()-&gt;getRequest()-&gt;getUri();
            // Make the URL relative (remove scheme, user info, host name and port)
            // to avoid redirecting to other domain by a malicious user.
            $uri-&gt;setScheme(null)
                -&gt;setHost(null)
                -&gt;setPort(null)
                -&gt;setUserInfo(null);
            $redirectUrl = $uri-&gt;toString();

            // Redirect the user to the "Login" page.
            return $controller-&gt;redirect()-&gt;toRoute('login', [],
                    ['query'=&gt;['redirectUrl'=&gt;$redirectUrl]]);
        }
    }
}
</code></pre>
<h3 id="Implementar_el_algoritmo_de_control_de_acceso">16.8.2. Implementar el algoritmo de control de acceso</h3>
<p>El event listener <code>onDispatch()</code> llama al método <code>filterAccess()</code> del servicio <code>AuthManager</code> para determinar
si la página puede ser vista o no. Mostramos abajo el código del método <code>filterAccess()</code>:</p>
<pre class=""><code class="language-php">/**
 * This is a simple access control filter. It allows vistors to visit certain pages only,
 * the rest requiring the user to be authenticated.
 *
 * This method uses the 'access_filter' key in the config file and determines
 * whenther the current visitor is allowed to access the given controller action
 * or not. It returns true if allowed; otherwise false.
 */
public function filterAccess($controllerName, $actionName)
{
    // Determine mode - 'restrictive' (default) or 'permissive'. In restrictive
    // mode all controller actions must be explicitly listed under the 'access_filter'
    // config key, and access is denied to any not listed action for unauthenticated users.
    // In permissive mode, if an action is not listed under the 'access_filter' key,
    // access to it is permitted to anyone (even for not logged in users.
    // Restrictive mode is more secure and recommended to use.
    $mode = isset($this-&gt;config['options']['mode'])?$this-&gt;config['options']['mode']:'restrictive';
    if ($mode!='restrictive' &amp;&amp; $mode!='permissive')
        throw new \Exception('Invalid access filter mode (expected either restrictive or permissive mode');

    if (isset($this-&gt;config['controllers'][$controllerName])) {
        $items = $this-&gt;config['controllers'][$controllerName];
        foreach ($items as $item) {
            $actionList = $item['actions'];
            $allow = $item['allow'];
            if (is_array($actionList) &amp;&amp; in_array($actionName, $actionList) ||
                $actionList=='*') {
                if ($allow=='*')
                    return true; // Anyone is allowed to see the page.
                else if ($allow=='@' &amp;&amp; $this-&gt;authService-&gt;hasIdentity()) {
                    return true; // Only authenticated user is allowed to see the page.
                } else {
                    return false; // Access denied.
                }
            }
        }
    }

    // In restrictive mode, we forbid access for unauthorized users to any
    // action not listed under 'access_filter' key (for security reasons).
    if ($mode=='restrictive' &amp;&amp; !$this-&gt;authService-&gt;hasIdentity())
        return false;

    // Permit access to this page.
    return true;
}
</code></pre>
<h3 id="Probar_el_filtro_de_acceso">16.8.3. Probar el filtro de acceso</h3>
<p>Para probar el filtro de acceso, intentamos visitar la página "http://localhost/users" o "http://localhost/settings" sin haber iniciado sesión.
El filtro de acceso redireccionará a la página de <em>Login</em>. Sin embargo, podemos visitar sin problemas la página "http://localhost/about", esta
está abierta para cualquiera.</p>
        
</div>

<!-- Ads -->
<div id="ads-chapter-bottom">
<div>
﻿<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Using Zend Framework 3 Chapter - Bottom - Adaptive -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3933778336056438"
     data-ad-slot="1546211126"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
</div>
    
<!-- Navigation -->
<div class="navigation">
        <div class="current-chapter">
        <a href="../Manejo_de_usuarios__autenticación_y_filtrado_de_acceso.html">
            <img alt="Contents" src="../../assets/images/upload.png"><span class="nav-btn-text">Manejo de usuarios, autenticación y filtrado de acceso</span>
        </a>
    </div>
        <div class="prev-chapter">
        
        <a href="../Manejo_de_usuarios__autenticación_y_filtrado_de_acceso/Implementar_la_autenticación_del_usuario.html">
            <img alt="Previous Chapter" src="../../assets/images/left.png"><span class="nav-btn-text">Previous</span>
        </a>
        </div>    
    <div class="contents">
        <a href="../toc.html">
            <img alt="Contents" src="../../assets/images/book.png"><span class="nav-btn-text">Contents</span>
        </a>
    </div>
    <div class="next-chapter">
                <a href="../Manejo_de_usuarios__autenticación_y_filtrado_de_acceso/Identity_Controller_Plugin_y_el_View_Helper.html">
            <span class="nav-btn-text">Next</span><img alt="Next Chapter" src="../../assets/images/right.png">
        </a>
            </div>        
</div>

<div id="disqus_thread"></div>

        
</div>
<footer>
    <div class="footer">
        <div class="footer-body">
            <div class="copyright">
                Copyright &copy; 2018 by Oleg Krivtsov            </div>
            <div class="footer-menu">
                                <div class="footer-link">
                    <a href="https://olegkrivtsov.github.io/using-zend-framework-3-book/legal/terms-and-conditions.html">Terms &amp; Conditions</a>
                </div>
                                <div class="footer-link">
                    <a href="https://olegkrivtsov.github.io/using-zend-framework-3-book/legal/copyright-policy.html">Copyright Policy</a>
                </div>
                                <div class="footer-link">
                    <a href="https://olegkrivtsov.github.io/using-zend-framework-3-book/legal/privacy-policy.html">Privacy Policy</a>
                </div>
                            </div>
            <div class="generated-by">
                Generated using <a href="https://github.com/olegkrivtsov/openbook">OpenBook</a>
            </div>
        </div>    
    </div>
</footer>

<a href="#0" class="cd-top">Top</a>

<script src="../../assets/js/jquery.min.js"></script>
<script src="../../assets/js/loadCSS.js"></script>
<script src="../../assets/js/popup.js"></script>

<script src="../../assets/js/prism.js"></script>

<script>
var disqus_config = function () {
this.page.url = window.location.href; // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = ''; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');

s.src = '//using-zend-framework-3-book.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
<script>
loadCSS("../../assets/css/prism.css");
</script>

<script>
jQuery(document).ready(function($){
    // browser window scroll (in pixels) after which the "back to top" link is shown
    var offset = 300,
    //browser window scroll (in pixels) after which the "back to top" link opacity is reduced
    offset_opacity = 1200,
    //duration of the top scrolling animation (in ms)
    scroll_top_duration = 700,
    //grab the "back to top" link
    $back_to_top = $('.cd-top');

    //hide or show the "back to top" link
    $(window).scroll(function(){
            ( $(this).scrollTop() > offset ) ? $back_to_top.addClass('cd-is-visible') : $back_to_top.removeClass('cd-is-visible cd-fade-out');
            if( $(this).scrollTop() > offset_opacity ) { 
                    $back_to_top.addClass('cd-fade-out');
            }
    });

    //smooth scroll to top
    $back_to_top.on('click', function(event){
            event.preventDefault();
            $('body,html').animate({
                    scrollTop: 0 ,
                    }, scroll_top_duration
            );
    });

});
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-80824388-1', 'auto');
  ga('send', 'pageview');

</script>

</body>
</html>    

