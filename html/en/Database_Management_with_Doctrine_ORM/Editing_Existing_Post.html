<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="description" content="A free, read-frendly and open-source book on ZF3">
<meta name="keywords" content="zend framework,book,beginner,free">
<meta name="author" content="2019 by Oleg Krivtsov">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="../../favicon.ico" rel="shortcut icon" type="image/ico" />
<link href="../../assets/css/style.css" type="text/css" rel="stylesheet" />
<title>Editing Existing Post &ndash; Using Zend Framework 3</title>
</head>
<body>
<header>
    <div class="header">
        <div class="header-body">
            <div class="book-title">
                <a href="../../index.html">Using Zend Framework 3</a>
            </div>
            <div class="book-subtitle">
                A free, read-frendly and open-source book on ZF3            </div>
            <nav>
                <div class="menu">
                                        <div class="link">
                        <a href="https://olegkrivtsov.github.io/using-zend-framework-3-book/html">Home</a>
                    </div>
                                        <div class="link">
                        <a href="https://github.com/olegkrivtsov/using-zf3-book-samples">Samples</a>
                    </div>
                                        <div class="link">
                        <a href="https://olegkrivtsov.github.io/zf3-api-reference/html/">Class Reference</a>
                    </div>
                                        <div class="link">
                        <a href="https://github.com/olegkrivtsov/using-zend-framework-3-book">Contribute</a>
                    </div>
                    
                </div>
            </nav>
        </div>    
    </div>
</header>    
<div id="container">
<!-- Navigation -->
<div class="navigation">
    <div class="prev-chapter">
        
        <a href="../Database_Management_with_Doctrine_ORM/Adding_New_Post.html">
            <img alt="Previous Chapter" src="../../assets/images/left.png"><span class="nav-btn-text">Previous</span>
        </a>
        </div>    
    <div class="contents">
        <a href="../toc.html">
            <img alt="Contents" src="../../assets/images/book.png"><span class="nav-btn-text">Contents</span>
        </a>
    </div>
    <div class="next-chapter">
                <a href="../Database_Management_with_Doctrine_ORM/Deleting_a_Post.html">
            <span class="nav-btn-text">Next</span><img alt="Next Chapter" src="../../assets/images/right.png">
        </a>
            </div>
        <div class="current-chapter">
        <a href="../Database_Management_with_Doctrine_ORM.html">
            <img alt="Contents" src="../../assets/images/upload.png"><span class="nav-btn-text">Database Management with Doctrine ORM</span>
        </a>
    </div>
    </div>

ï»¿<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Using Zend Framework 3 Book - Chapter - Adaptive -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3933778336056438"
     data-ad-slot="4531860323"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!-- Chapter content -->
<div id="chapter_content">

<h2 id="Editing_Existing_Post">12.10. Editing Existing Post</h2>
<p>In this section, we will implement the <em>Edit Post</em> page which contains the form allowing to edit 
the data of existing post, send new data to server and apply changes to database. Site visitor will
be able to see the page by entering the following URL in browser's navigation
bar: <em>http://localhost/posts/edit/&lt;id&gt;</em>, where <em>&lt;id&gt;</em> is the unique 
identifier of the post.</p>
<p>To implement this page we need the following things:</p>
<ul>
<li>create a form that would allow to enter post title, content, etc. For this page, we can 
successfully reuse the <code>PostForm</code> form we created earlier (we just rename the <em>Create</em> button
caption into <em>Save</em>).</li>
<li>add <code>updatePost()</code> method to the <code>PostManager</code> service. The method would find the post by 
ID in database and update its data;</li>
<li>add <code>convertTagsToString()</code> method to the <code>PostManager</code> service. This method would take the
post entity, and on output produce string containing comma-separated list of tags;</li>
<li>add the <code>PostController::editAction()</code> action method that would take user input, pass it 
to models and return data for rendering;</li>
<li>and add the <em>edit.phtml</em> view template file that would render the form.</li>
</ul>
<h3 id="Modifying_PostManager">12.10.1. Modifying PostManager</h3>
<p>First, we add the <code>updatePost()</code> and <code>convertTagsToString()</code> methods to the <code>PostManager</code> service 
model as follows:</p>
<pre class="line-numbers"><code class="language-php">&lt;?php
//...
class PostManager
{
    //...
	
    // This method allows to update data of a single post.
    public function updatePost($post, $data) 
    {
        $post-&gt;setTitle($data['title']);
        $post-&gt;setContent($data['content']);
        $post-&gt;setStatus($data['status']);
        
        // Add tags to post
        $this-&gt;addTagsToPost($data['tags'], $post);
        
        // Apply changes to database.
        $this-&gt;entityManager-&gt;flush();
    }
        
    // Converts tags of the given post to comma separated list (string).
    public function convertTagsToString($post) 
    {
        $tags = $post-&gt;getTags();
        $tagCount = count($tags);
        $tagsStr = '';
        $i = 0;
        foreach ($tags as $tag) {
            $i ++;
            $tagsStr .= $tag-&gt;getName();
            if ($i &lt; $tagCount) 
                $tagsStr .= ', ';
        }
        
        return $tagsStr;
    }    
}
</code></pre>
<p>Above, we have the <code>updatePost()</code> method (lines 8-19) that takes an existing <code>Post</code> entity, 
the new title, content, status and the list of tags. It then updates entity's properties and 
saves changes to database using <code>flush()</code> method.</p>
<blockquote class="notquote information" data-type="information"><p> Note that the <code>updatePost()</code> method doesn't use the <code>persist()</code> method of entity manager, because
   here we have existing post, not a new one.</p>
</blockquote><p>Then, we have the <code>convertTagsToString()</code> method (lines 22-36) which takes the post, goes through 
<code>Tag</code> entities associated with the post and formats and returns the comma-separated list of tags.  </p>
<h3 id="Adding_Controller_Action_and_View_Template">12.10.2. Adding Controller Action and View Template</h3>
<p>Next, add the <code>editAction()</code> to <code>PostController</code> controller class as follows:</p>
<pre class=""><code class="language-php">&lt;?php
namespace Application\Controller;
//...
use Application\Form\PostForm;
use Application\Entity\Post;

class PostController extends AbstractActionController 
{
  // This action displays the page allowing to edit a post.
  public function editAction() 
  {
    // Create the form.
    $form = new PostForm();
    
    // Get post ID.    
    $postId = $this-&gt;params()-&gt;fromRoute('id', -1);
    
    // Find existing post in the database.    
    $post = $this-&gt;entityManager-&gt;getRepository(Post::class)
                -&gt;findOneById($postId);        
    if ($post == null) {
      $this-&gt;getResponse()-&gt;setStatusCode(404);
      return;                        
    } 
        
    // Check whether this post is a POST request.
    if ($this-&gt;getRequest()-&gt;isPost()) {
            
      // Get POST data.
      $data = $this-&gt;params()-&gt;fromPost();
            
      // Fill form with data.
      $form-&gt;setData($data);
      if ($form-&gt;isValid()) {
                                
        // Get validated form data.
        $data = $form-&gt;getData();
                
        // Use post manager service to add new post to database.                
        $this-&gt;postManager-&gt;updatePost($post, $data);
                
        // Redirect the user to "admin" page.
        return $this-&gt;redirect()-&gt;toRoute('posts', ['action'=&gt;'admin']);
      }
    } else {
      $data = [
               'title' =&gt; $post-&gt;getTitle(),
               'content' =&gt; $post-&gt;getContent(),
               'tags' =&gt; $this-&gt;postManager-&gt;convertTagsToString($post),
               'status' =&gt; $post-&gt;getStatus()
            ];
            
      $form-&gt;setData($data);
    }
        
    // Render the view template.
    return new ViewModel([
            'form' =&gt; $form,
            'post' =&gt; $post
        ]);  
  }
}
</code></pre>
<p>In the code above, we extract the post ID using the <code>fromRoute()</code> method of the <code>params()</code> controller
plugin. Then we search for post having such ID using the <code>findOneBy()</code> method provided by the
entity repository. </p>
<p>Then we check if this is a POST request. If this is the POST request, we fill in and validate the form
with POST data. Then we use the <code>updatePost()</code> method of the <code>PostManager</code> service.</p>
<p>Finally, create the <em>application/post/edit.phtml</em> file under the module's <em>view</em> directory. Place the
following content there:</p>
<pre class=""><code class="language-php">&lt;?php
$form = $this-&gt;form;
$form-&gt;get('title')-&gt;setAttributes([
    'class'=&gt;'form-control', 
    'placeholder'=&gt;'Enter post title here'
    ]);
$form-&gt;get('content')-&gt;setAttributes([
    'class'=&gt;'form-control', 
    'placeholder'=&gt;'Type content here',
    'rows'=&gt;6
    ]);
$form-&gt;get('tags')-&gt;setAttributes([
    'class'=&gt;'form-control', 
    'placeholder'=&gt;'comma, separated, list, of, tags'
    ]);
$form-&gt;get('status')-&gt;setAttributes([
    'class'=&gt;'form-control'   
    ]);
$form-&gt;get('submit')-&gt;setAttributes(['class'=&gt;'btn btn-primary']);
$form-&gt;get('submit')-&gt;setValue('Save');
$form-&gt;prepare();

?&gt;

&lt;h1&gt;Edit Post&lt;/h1&gt;

&lt;p&gt;
    Please fill out the following form and click the *Save* button.
&lt;/p&gt;

&lt;div class="row"&gt;
    &lt;div class="col-md-6"&gt;
        &lt;?= $this-&gt;form()-&gt;openTag($form); ?&gt;
        
        &lt;div class="form-group"&gt;
            &lt;?= $this-&gt;formLabel($form-&gt;get('title')); ?&gt;
            &lt;?= $this-&gt;formElement($form-&gt;get('title')); ?&gt;
            &lt;?= $this-&gt;formElementErrors($form-&gt;get('title')); ?&gt;                  
        &lt;/div&gt;
        
        &lt;div class="form-group"&gt;
            &lt;?= $this-&gt;formLabel($form-&gt;get('content')); ?&gt;
            &lt;?= $this-&gt;formElement($form-&gt;get('content')); ?&gt;
            &lt;?= $this-&gt;formElementErrors($form-&gt;get('content')); ?&gt;                  
        &lt;/div&gt;
        
        &lt;div class="form-group"&gt;
            &lt;?= $this-&gt;formLabel($form-&gt;get('tags')); ?&gt;
            &lt;?= $this-&gt;formElement($form-&gt;get('tags')); ?&gt;
            &lt;?= $this-&gt;formElementErrors($form-&gt;get('tags')); ?&gt;                  
            &lt;p class="help-block"&gt;Separate tags with comma.&lt;/p&gt;
        &lt;/div&gt;

        &lt;div class="form-group"&gt;
            &lt;?= $this-&gt;formLabel($form-&gt;get('status')); ?&gt;
            &lt;?= $this-&gt;formElement($form-&gt;get('status')); ?&gt;
            &lt;?= $this-&gt;formElementErrors($form-&gt;get('status')); ?&gt;                  
        &lt;/div&gt;
        
        &lt;?= $this-&gt;formElement($form-&gt;get('submit')); ?&gt;
        
        &lt;?= $this-&gt;form()-&gt;closeTag(); ?&gt;
    &lt;/div&gt;    
&lt;/div&gt;   
</code></pre>
<p>Now, if you open the URL <em>http://localhost/posts/edit/&lt;id&gt;</em> in your web browser, 
you should be able to see the <em>Edit Post</em> page that allows to edit an existing post (see the figure 12.8 below):</p>
<p><span class="image-wrapper">
<a target="_blank" href="../images/doctrine/edit_post.png">
<img src="../images/doctrine/edit_post.png" alt="Figure 12.8. Edit Post page" /></a>
<span class="image-caption">Figure 12.8. Edit Post page</span>
</span>
 </p>
<p>Clicking the <em>Save</em> button results in saving the changes to database. </p>
        
</div>

<!-- Ads -->
<div id="ads-chapter-bottom">
<div>
ï»¿<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Using Zend Framework 3 Chapter - Bottom - Adaptive -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3933778336056438"
     data-ad-slot="1546211126"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
</div>
    
<!-- Navigation -->
<div class="navigation">
        <div class="current-chapter">
        <a href="../Database_Management_with_Doctrine_ORM.html">
            <img alt="Contents" src="../../assets/images/upload.png"><span class="nav-btn-text">Database Management with Doctrine ORM</span>
        </a>
    </div>
        <div class="prev-chapter">
        
        <a href="../Database_Management_with_Doctrine_ORM/Adding_New_Post.html">
            <img alt="Previous Chapter" src="../../assets/images/left.png"><span class="nav-btn-text">Previous</span>
        </a>
        </div>    
    <div class="contents">
        <a href="../toc.html">
            <img alt="Contents" src="../../assets/images/book.png"><span class="nav-btn-text">Contents</span>
        </a>
    </div>
    <div class="next-chapter">
                <a href="../Database_Management_with_Doctrine_ORM/Deleting_a_Post.html">
            <span class="nav-btn-text">Next</span><img alt="Next Chapter" src="../../assets/images/right.png">
        </a>
            </div>        
</div>

<div id="disqus_thread"></div>

        
</div>
<footer>
    <div class="footer">
        <div class="footer-body">
            <div class="copyright">
                Copyright &copy; 2019 by Oleg Krivtsov            </div>
            <div class="footer-menu">
                                <div class="footer-link">
                    <a href="https://olegkrivtsov.github.io/using-zend-framework-3-book/legal/terms-and-conditions.html">Terms &amp; Conditions</a>
                </div>
                                <div class="footer-link">
                    <a href="https://olegkrivtsov.github.io/using-zend-framework-3-book/legal/copyright-policy.html">Copyright Policy</a>
                </div>
                                <div class="footer-link">
                    <a href="https://olegkrivtsov.github.io/using-zend-framework-3-book/legal/privacy-policy.html">Privacy Policy</a>
                </div>
                            </div>
            <div class="generated-by">
                Generated using <a href="https://github.com/olegkrivtsov/openbook">OpenBook</a>
            </div>
        </div>    
    </div>
</footer>

<a href="#0" class="cd-top">Top</a>

<script src="../../assets/js/jquery.min.js"></script>
<script src="../../assets/js/loadCSS.js"></script>
<script src="../../assets/js/popup.js"></script>

<script src="../../assets/js/prism.js"></script>

<script>
var disqus_config = function () {
this.page.url = window.location.href; // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = ''; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');

s.src = '//using-zend-framework-3-book.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
<script>
loadCSS("../../assets/css/prism.css");
</script>

<script>
jQuery(document).ready(function($){
    // browser window scroll (in pixels) after which the "back to top" link is shown
    var offset = 300,
    //browser window scroll (in pixels) after which the "back to top" link opacity is reduced
    offset_opacity = 1200,
    //duration of the top scrolling animation (in ms)
    scroll_top_duration = 700,
    //grab the "back to top" link
    $back_to_top = $('.cd-top');

    //hide or show the "back to top" link
    $(window).scroll(function(){
            ( $(this).scrollTop() > offset ) ? $back_to_top.addClass('cd-is-visible') : $back_to_top.removeClass('cd-is-visible cd-fade-out');
            if( $(this).scrollTop() > offset_opacity ) { 
                    $back_to_top.addClass('cd-fade-out');
            }
    });

    //smooth scroll to top
    $back_to_top.on('click', function(event){
            event.preventDefault();
            $('body,html').animate({
                    scrollTop: 0 ,
                    }, scroll_top_duration
            );
    });

});
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-80824388-1', 'auto');
  ga('send', 'pageview');

</script>

</body>
</html>    

